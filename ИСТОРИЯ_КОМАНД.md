# История команд робота

## Описание

Модуль `command_history.py` добавляет функциональность сохранения и загрузки истории команд, отправленных роботу. История автоматически сохраняется в файл JSON и загружается при запуске сервера робота.

## Возможности

- ✅ Автоматическое сохранение всех команд в файл JSON
- ✅ Загрузка истории при запуске приложения
- ✅ Хранение метаданных: временная метка, команда, статус, дополнительные данные
- ✅ Ограничение размера истории (по умолчанию 1000 записей)
- ✅ Отображение последних N команд в консоли

## Интеграция

История команд интегрирована в следующие серверы управления роботом:

1. **edet_robot.py** - основной сервер с gpiozero
2. **sys_robot.py** - сервер через sysfs
3. **fedet_robot.py** - сервер с gpiod

При запуске любого из этих серверов:
- История загружается из файла `robot_command_history.json`
- Выводятся последние 10 команд (если есть)
- Все новые команды автоматически сохраняются

## Формат истории

История сохраняется в файл `robot_command_history.json` в следующем формате:

```json
[
  {
    "timestamp": "2026-01-27T08:18:48.336191",
    "command": "forward",
    "status": "success",
    "response": {
      "speed": 0.7
    }
  },
  {
    "timestamp": "2026-01-27T08:18:49.837351",
    "command": "stop",
    "status": "success"
  }
]
```

## Использование

### В коде сервера робота

```python
from command_history import CommandHistory

# Инициализация
history = CommandHistory('robot_command_history.json', max_entries=1000)

# Загрузка истории при запуске
history.load_history()
history.print_history(10)  # Показать последние 10 команд

# Добавление команды
history.add_command("forward", "success", {"speed": 0.7})

# При ошибке
history.add_command("invalid_cmd", "error", {"reason": "unknown_command"})
```

### Тестирование

Запустите тесты для проверки работы истории:

```bash
python3 test_command_history.py
```

### Демонстрация

Запустите демонстрационный скрипт для симуляции работы:

```bash
python3 demo_history.py
```

Запустите несколько раз, чтобы увидеть, как история накапливается между сеансами.

## API класса CommandHistory

### Методы

- `load_history()` - загружает историю из файла
- `save_history()` - сохраняет историю в файл
- `add_command(command, status, response_data)` - добавляет команду
- `get_last_commands(count)` - возвращает последние N команд
- `get_all_commands()` - возвращает всю историю
- `clear_history()` - очищает историю
- `print_history(last_n)` - выводит последние N команд в консоль

### Параметры конструктора

- `history_file` - имя файла для сохранения (по умолчанию 'robot_command_history.json')
- `max_entries` - максимальное количество записей (по умолчанию 1000)

## Примеры команд в истории

Типы команд, которые сохраняются:

- `forward` - движение вперед
- `backward` - движение назад
- `left` - поворот влево
- `right` - поворот вправо
- `stop` - остановка
- `speed:X.X` - изменение скорости

Каждая команда содержит:
- Временную метку (timestamp)
- Саму команду (command)
- Статус выполнения (status: "success" или "error")
- Дополнительные данные (response: скорость, причина ошибки и т.д.)

## Примечания

- История автоматически ограничивается до `max_entries` записей
- Файл истории добавлен в `.gitignore` и не коммитится в репозиторий
- История сохраняется после каждой команды для надежности
